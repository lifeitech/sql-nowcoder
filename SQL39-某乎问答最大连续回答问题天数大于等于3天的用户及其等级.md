# SQL39Â æŸä¹é—®ç­”æœ€å¤§è¿ç»­å›ç­”é—®é¢˜å¤©æ•°å¤§äºç­‰äº3å¤©çš„ç”¨æˆ·åŠå…¶ç­‰çº§

è¾ƒéš¾Â Â é€šè¿‡ç‡ï¼š51.47%Â Â æ—¶é—´é™åˆ¶ï¼š1ç§’Â Â ç©ºé—´é™åˆ¶ï¼š256M

## æè¿°

ç°æœ‰æŸä¹é—®ç­”åˆ›ä½œè€…ä¿¡æ¯è¡¨author_tbå¦‚ä¸‹(å…¶ä¸­author_idè¡¨ç¤ºåˆ›ä½œè€…ç¼–å·ã€author_levelè¡¨ç¤ºåˆ›ä½œè€…çº§åˆ«ï¼Œå…±1-6å…­ä¸ªçº§åˆ«ã€sexè¡¨ç¤ºåˆ›ä½œè€…æ€§åˆ«)ï¼š

| author_id | author_level | sex |
| --------- | ------------ | --- |
| 101       | 6            | m   |
| 102       | 1            | f   |
| 103       | 1            | m   |
| 104       | 3            | m   |
| 105       | 4            | f   |
| 106       | 2            | f   |
| 107       | 2            | m   |
| 108       | 5            | f   |
| 109       | 6            | f   |
| 110       | 5            | m   |

åˆ›ä½œè€…å›ç­”æƒ…å†µè¡¨answer_tbå¦‚ä¸‹ï¼ˆå…¶ä¸­answer_dateè¡¨ç¤ºåˆ›ä½œæ—¥æœŸã€author_idæŒ‡åˆ›ä½œè€…ç¼–å·ã€issue_idæŒ‡å›ç­”é—®é¢˜ç¼–å·ã€char_lenè¡¨ç¤ºå›ç­”å­—æ•°ï¼‰ï¼š  

| answer_date | author_id | issue_id | char_len |
| ----------- | --------- | -------- | -------- |
| 2021-11-01  | 101       | E001     | 150      |
| 2021-11-01  | 101       | E002     | 200      |
| 2021-11-01  | 102       | C003     | 50       |
| 2021-11-01  | 103       | P001     | 35       |
| 2021-11-01  | 104       | C003     | 120      |
| 2021-11-01  | 105       | P001     | 125      |
| 2021-11-01  | 102       | P002     | 105      |
| 2021-11-02  | 101       | P001     | 201      |
| 2021-11-02  | 110       | C002     | 200      |
| 2021-11-02  | 110       | C001     | 225      |
| 2021-11-02  | 110       | C002     | 220      |
| 2021-11-03  | 101       | C002     | 180      |
| 2021-11-04  | 109       | E003     | 130      |
| 2021-11-04  | 109       | E001     | 123      |
| 2021-11-05  | 108       | C001     | 160      |
| 2021-11-05  | 108       | C002     | 120      |
| 2021-11-05  | 110       | P001     | 180      |
| 2021-11-05  | 106       | P002     | 45       |
| 2021-11-05  | 107       | E003     | 56       |

è¯·ä½ ç»Ÿè®¡æœ€å¤§è¿ç»­å›ç­”é—®é¢˜çš„å¤©æ•°å¤§äºç­‰äº3å¤©çš„ç”¨æˆ·åŠå…¶ç­‰çº§ï¼ˆè‹¥æœ‰å¤šæ¡ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼ŒæŒ‰author_idå‡åºæ’åºï¼‰ï¼Œä»¥ä¸Šä¾‹å­çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

| author_id | author_level | days_cnt |
| --------- | ------------ | -------- |
| 101       | 6            | 3        |

## ç­”æ¡ˆ

```sql
select F.author_id, author_level, days_cnt
from
### table F
(select author_id, sum(ddiff) + 1 as days_cnt
from
(select author_id, datediff(date_lead, answer_date) as ddiff
from
(select author_id, answer_date, lead(answer_date) over (partition by author_id order by answer_date) as date_lead
from
(select distinct author_id, answer_date from answer_tb order by author_id) as x) as y having ddiff=1) as z
group by author_id
having days_cnt >= 3
 ) as F 
### table F
join author_tb as auth
on F.author_id = auth.author_id
```

## æ€è·¯

æœ¬é¢˜çš„éš¾ç‚¹åœ¨äºè®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ã€Œæœ€å¤§è¿ç»­å›ç­”å¤©æ•°ã€ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæœ€åçš„ç­”æ¡ˆåƒå¥—å¨ƒä¸€æ ·ğŸ˜‚ å¥—äº†5ä¸ªselectã€‚é‚£ä¹ˆæˆ‘ä»¬å°±ä»æœ€é‡Œé¢å¼€å§‹ï¼Œä¸€å±‚ä¸€å±‚çš„åˆ†è§£ã€‚

é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼Œ`answer_tb`é‡Œé¢æœ‰ç”¨çš„columnæ˜¯`answer_date`å’Œ`author_id`ï¼Œå…¶ä»–çš„éƒ½æ²¡ç”¨ã€‚`author_tb`åªæ˜¯ç”¨æ¥æœ€åè´´æ ‡ç­¾çš„ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿæ²¡æœ‰ç”¨ã€‚

ä»¥ä¸‹æ­¥éª¤ç”¨ç”¨æˆ·101è¿›è¡Œç¤ºæ„ã€‚

---

1ï¸âƒ£ æŠŠè¦è®¡ç®—çš„ä¸¤ä¸ªcolumn `answer_date`å’Œ`author_id` ä»`answer_tb`é‡Œé¢æå–å‡ºæ¥ã€‚

```sql
ï¼ˆselect distinct author_id, answer_date from answer_tb
order by author_id) as x
```

ç”¨äº†`distinct`ï¼Œå°±å¯ä»¥å»é‡ä¸€ä¸ªç”¨æˆ·åœ¨åŒä¸€å¤©å›ç­”å¤šä¸ªé—®é¢˜çš„æƒ…å†µã€‚

å½“ç„¶å¯ä»¥åœ¨æœ€åè¾“å‡ºç­”æ¡ˆçš„æ—¶å€™å†order byï¼Œè¿™é‡Œä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šç›´è§‚ï¼Œå…ˆæŒ‰author_idæ’åºã€‚

| author_id | answer_date |
| --------- | ----------- |
| 101       | 2021-11-01  |
| 101       | 2021-11-02  |
| 101       | 2021-11-03  |
| 102       | 2011-11-01  |
| 103       | ...         |
| ...       | ...         |

2ï¸âƒ£ æˆ‘ä»¬ç”¨`lead`è¿™ä¸ªwindow functionï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„columnï¼Œå€¼æ˜¯æŠŠæ¯ä¸ªç”¨æˆ·çš„`answer_date`è¿™ä¸ªcolumnä¸Šç§»ä¸€æ ¼ã€‚

```sql
(select author_id, answer_date, 
lead(answer_date) over (partition by author_id order by answer_date) as date_lead
from x) as y
```

| author_id | answer_date | date_lead  |
| --------- | ----------- | ---------- |
| 101       | 2021-11-01  | 2021-11-02 |
| 101       | 2021-11-02  | 2021-11-03 |
| 101       | 2021-11-03  | null       |
| 102       | 2021-11-01  | null       |
| ...       | ...         | ...        |
| 110       | 2021-11-02  | 2021-11-05 |
| ...       | ...         | ...        |

3ï¸âƒ£ ç”¨`datediff`è¿™ä¸ªdate functionï¼ŒæŠŠä¸¤ä¸ªæ—¥æœŸcolumnç›¸å‡ï¼Œå¾—åˆ°`ddiff`è¿™ä¸ªcolumnï¼Œå€¼ä¸º1çš„æ‰èµ·ç æ˜¯è¿ç»­çš„ã€‚

```sql
(select author_id, datediff(date_lead, answer_date) as ddiff
from y having ddiff=1) as z
```

| author_id | ddiff |
| --------- | ----- |
| 101       | 1     |
| 101       | 1     |

4ï¸âƒ£æŠŠæ¯ä¸ªç”¨æˆ·çš„`ddiff`åŠ èµ·æ¥ï¼ˆå†åŠ 1ï¼‰å³æ˜¯æœ€å¤§è¿ç»­å›ç­”å¤©æ•°ã€‚

```sql
(select author_id, sum(ddiff) + 1 as days_cnt
from z
group by author_id
having days_cnt >= 3
 ) as F 
```

| author_id | days_cnt |
| --------- | -------- |
| 101       | 3        |

5ï¸âƒ£æœ€åå†æŒ‰é¢˜ç›®è¦æ±‚è´´ä¸Š`author_level`çš„æ ‡ç­¾å³å¯ã€‚

```sql
select F.author_id, author_level, days_cnt
from F
join author_tb as auth
on F.author_id = auth.author_id
```

| author_id | author_level | days_cnt |
| --------- | ------------ | -------- |
| 101       | 6            | 3        |


