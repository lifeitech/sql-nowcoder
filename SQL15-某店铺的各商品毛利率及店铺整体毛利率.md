# SQL15Â æŸåº—é“ºçš„å„å•†å“æ¯›åˆ©ç‡åŠåº—é“ºæ•´ä½“æ¯›åˆ©ç‡

ä¸­ç­‰Â Â é€šè¿‡ç‡ï¼š24.96%Â Â æ—¶é—´é™åˆ¶ï¼š1ç§’Â Â ç©ºé—´é™åˆ¶ï¼š256M

## æè¿°

å•†å“ä¿¡æ¯è¡¨tb_product_info

| id  | product_id | shop_id | tag  | in_price | quantity | release_time        |
| --- | ---------- | ------- | ---- | -------- | -------- | ------------------- |
| 1   | 8001       | 901     | å®¶ç”µ   | 6000     | 100      | 2020-01-01 10:00:00 |
| 2   | 8002       | 902     | å®¶ç”µ   | 12000    | 50       | 2020-01-01 10:00:00 |
| 3   | 8003       | 901     | 3Cæ•°ç  | 12000    | 50       | 2020-01-01 10:00:00 |

ï¼ˆproduct_id-å•†å“ID, shop_id-åº—é“ºID, tag-å•†å“ç±»åˆ«æ ‡ç­¾, in_price-è¿›è´§ä»·æ ¼, quantity-è¿›è´§æ•°é‡, release_time-ä¸Šæ¶æ—¶é—´ï¼‰  

è®¢å•æ€»è¡¨tb_order_overall

| id  | order_id | uid | event_time          | total_amount | total_cnt | status |
| --- | -------- | --- | ------------------- | ------------ | --------- | ------ |
| 1   | 301001   | 101 | 2021-10-01 10:00:00 | 30000        | 3         | 1      |
| 2   | 301002   | 102 | 2021-10-01 11:00:00 | 23900        | 2         | 1      |
| 3   | 301003   | 103 | 2021-10-02 10:00:00 | 31000        | 2         | 1      |

ï¼ˆorder_id-è®¢å•å·, uid-ç”¨æˆ·ID, event_time-ä¸‹å•æ—¶é—´, total_amount-è®¢å•æ€»é‡‘é¢, total_cnt-è®¢å•å•†å“æ€»ä»¶æ•°, status-è®¢å•çŠ¶æ€ï¼‰

è®¢å•æ˜ç»†è¡¨tb_order_detail

| id  | order_id | product_id | price | cnt |
| --- | -------- | ---------- | ----- | --- |
| 1   | 301001   | 8001       | 8500  | 2   |
| 2   | 301001   | 8002       | 15000 | 1   |
| 3   | 301002   | 8001       | 8500  | 1   |
| 4   | 301002   | 8002       | 16000 | 1   |
| 5   | 301003   | 8002       | 14000 | 1   |
| 6   | 301003   | 8003       | 18000 | 1   |

ï¼ˆorder_id-è®¢å•å·, product_id-å•†å“ID, price-å•†å“å•ä»·, cnt-ä¸‹å•æ•°é‡ï¼‰

**åœºæ™¯é€»è¾‘è¯´æ˜**ï¼š

- ç”¨æˆ·å°†è´­ç‰©è½¦ä¸­å¤šä»¶å•†å“ä¸€èµ·ä¸‹å•æ—¶ï¼Œè®¢å•æ€»è¡¨ä¼šç”Ÿæˆä¸€ä¸ªè®¢å•ï¼ˆä½†æ­¤æ—¶æœªä»˜æ¬¾ï¼Œ**status-è®¢å•çŠ¶æ€**ä¸º**0**è¡¨ç¤ºå¾…ä»˜æ¬¾ï¼‰ï¼Œåœ¨è®¢å•æ˜ç»†è¡¨ç”Ÿæˆè¯¥è®¢å•ä¸­æ¯ä¸ªå•†å“çš„ä¿¡æ¯ï¼›

- å½“ç”¨æˆ·æ”¯ä»˜å®Œæˆæ—¶ï¼Œåœ¨è®¢å•æ€»è¡¨ä¿®æ”¹å¯¹åº”è®¢å•è®°å½•çš„**status-è®¢å•çŠ¶æ€**ä¸º**1**è¡¨ç¤ºå·²ä»˜æ¬¾ï¼›

- è‹¥ç”¨æˆ·é€€è´§é€€æ¬¾ï¼Œåœ¨è®¢å•æ€»è¡¨ç”Ÿæˆä¸€æ¡äº¤æ˜“æ€»é‡‘é¢ä¸ºè´Ÿå€¼çš„è®°å½•ï¼ˆè¡¨ç¤ºé€€æ¬¾é‡‘é¢ï¼Œè®¢å•å·ä¸ºé€€æ¬¾å•å·ï¼Œ**status-è®¢å•çŠ¶æ€**ä¸º2è¡¨ç¤ºå·²é€€æ¬¾ï¼‰ã€‚

**é—®é¢˜**ï¼šè¯·è®¡ç®—2021å¹´10æœˆä»¥æ¥åº—é“º901ä¸­å•†å“æ¯›åˆ©ç‡å¤§äº24.9%çš„å•†å“ä¿¡æ¯åŠåº—é“ºæ•´ä½“æ¯›åˆ©ç‡ã€‚

**æ³¨**ï¼šå•†å“æ¯›åˆ©ç‡=(1-è¿›ä»·/å¹³å‡å•ä»¶å”®ä»·)*100%ï¼›

åº—é“ºæ¯›åˆ©ç‡=(1-æ€»è¿›ä»·æˆæœ¬/æ€»é”€å”®æ”¶å…¥)*100%ã€‚

ç»“æœå…ˆè¾“å‡ºåº—é“ºæ¯›åˆ©ç‡ï¼Œå†æŒ‰å•†å“IDå‡åºè¾“å‡ºå„å•†å“æ¯›åˆ©ç‡ï¼Œå‡ä¿ç•™1ä½å°æ•°ã€‚

**è¾“å‡ºç¤ºä¾‹**ï¼š

ç¤ºä¾‹æ•°æ®çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

| product_id | profit_rate |
| ---------- | ----------- |
| åº—é“ºæ±‡æ€»       | 31.0%       |
| 8001       | 29.4%       |
| 8003       | 33.3%       |

è§£é‡Šï¼š

åº—é“º901æœ‰ä¸¤ä»¶å•†å“8001å’Œ8003ï¼›8001å”®å‡ºäº†3ä»¶ï¼Œé”€å”®æ€»é¢ä¸º25500ï¼Œè¿›ä»·æ€»é¢ä¸º18000ï¼Œæ¯›åˆ©ç‡ä¸º1-18000/25500=29.4%ï¼Œ8003å”®å‡ºäº†1ä»¶ï¼Œå”®ä»·ä¸º18000ï¼Œè¿›ä»·ä¸º12000ï¼Œæ¯›åˆ©ç‡ä¸º33.3%ï¼›

åº—é“ºå–å‡ºçš„è¿™4ä»¶å•†å“æ€»é”€å”®é¢ä¸º43500ï¼Œæ€»è¿›ä»·ä¸º30000ï¼Œæ¯›åˆ©ç‡ä¸º1-30000/43500=31.0%

[é¢˜ç›®é“¾æ¥](https://www.nowcoder.com/practice/65de67f666414c0e8f9a34c08d4a8ba6)

## ç­”æ¡ˆ

```sql
with y as
(select p2.product_id, p2.in_price, x2.Q, x2.gr_rev from
(select x.product_id, sum(x.cnt) as Q, sum(x.price * x.cnt) as gr_rev
from
(select p.shop_id, p.product_id, detail.price, detail.cnt, t.order_id, t.event_time, t.status 
from
tb_product_info as p
left join
tb_order_detail as detail
on p.product_id = detail.product_id
right join tb_order_overall as t
on detail.order_id = t.order_id
where p.shop_id = 901 and t.event_time >= '2021-10-01' and t.status = 1) as x
group by x.product_id) as x2
join (select product_id, in_price from tb_product_info) as p2
on x2.product_id = p2.product_id
)
### end of the y table
select 'åº—é“ºæ±‡æ€»' as product_id, concat(round((1 - sum(y.in_price * y.Q) / sum(y.gr_rev)) * 100, 1), '%') as profit_rate
from y
union all
(select y.product_id, concat(round((1 - y.in_price * y.Q / y.gr_rev) * 100, 1), '%') as profit_rate
from y having cast(profit_rate as float) > 24.9 order by y.product_id)
```

## æ€è·¯

è¿™é“é¢˜é€šè¿‡ç‡éå¸¸ä½ï¼Œå› ä¸ºéš¾åº¦æå¤§ã€‚æˆ‘çš„ç­”æ¡ˆæœ‰äºŒåå¤šè¡Œï¼Œæ˜¯æˆ‘ç›®å‰å†™è¿‡çš„æœ€å¤æ‚çš„queryã€‚

å…¶å®ä¸»ä½“éƒ¨åˆ†éš¾åº¦å¹¶ä¸ç®—å¤§ï¼Œä½†æœ‰ä¸¤ä¸ªè¦æ±‚è®©è¿™é“é¢˜å˜å¾—å°¤å…¶éš¾ä»¥é€šè¿‡ï¼š

1. è®¡ç®—çš„å„åº—é“ºçš„æ¯›åˆ©ç‡è¡¨æ ¼å‰é¢è¿˜è¦åŠ ä¸€è¡Œâ€åº—é“ºæ±‡æ€»â€œï¼Œè¿™ä¸ªå°±é™¡ç„¶å¢åŠ äº†ä¸å°‘éš¾åº¦ã€‚æˆ‘çš„ç­”æ¡ˆä¸­å°±ä¸å¾—ä¸ç”¨ with statementï¼Œæœ€åç”¨union allæŠŠä¸¤ä¸ªè¡¨æ ¼åˆèµ·æ¥ï¼›

2. ç‰›å®¢ç½‘åå°é»˜è®¤è®¾ç½®çš„æ˜¯ `sql_mode=only_full_group_by`ï¼Œæ‰€ä»¥group byçš„æ—¶å€™é€‰æ‹©å•†å“ä¿¡æ¯è¡¨çš„è¿›ä»·`in_price`ä¼šæŠ¥é”™ï¼Œåªèƒ½group byä¹‹åå†selectä¸€æ¬¡ï¼Œä¹Ÿå¤§å¹…å¢åŠ äº†è°ƒè¯•ä»£ç çš„æ—¶é•¿ã€‚è‡ªå·±å¹³æ—¶å·¥ä½œä¸­åº”è¯¥å®Œå…¨æ²¡æœ‰å¿…è¦è¿™æ ·ï¼Œå†µä¸”æœ¬é¢˜ä¸­æ¯ä»¶å•†å“åªæœ‰ä¸€ä¸ªè¿›ä»·ï¼Œä¸å­˜åœ¨ambiguityã€‚æ‰€ä»¥å®é™…ä¸­ç”¨
   
   ```sql
   set global sql_mode=(select replace(@@sql_mode,'ONLY_FULL_GROUP_BY',''));
   ```
   
   å‘½ä»¤æŠŠstrict modeå…³æ‰å°±å¥½ã€‚

é™¤äº†è¿™ä¸¤ç‚¹è¦æ±‚å¾ˆå˜æ€ï¼Œä¸»ä½“éƒ¨åˆ†è¿˜å¥½ï¼Œéš¾åº¦ä¸­ç­‰ï¼Œæ€è·¯è·Ÿ

[SQL35 æµ™å¤§ä¸åŒéš¾åº¦é¢˜ç›®çš„æ­£ç¡®ç‡](/SQL35-æµ™å¤§ä¸åŒéš¾åº¦é¢˜ç›®çš„æ­£ç¡®ç‡.md)

è¿™é“é¢˜æ˜¯ç›¸ä¼¼çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥èµ°ã€‚

1ï¸âƒ£ æˆ‘ä»¬æƒ³è¦è®¡ç®—çš„æ˜¯æ¯ä»¶å•†å“çš„æ¯›åˆ©ç‡ã€‚å•†å“çš„åŸºæœ¬ä¿¡æ¯åœ¨`tb_product_info`é‡Œé¢ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä»¥è¿™å¼ è¡¨çš„`product_id`ä¸ºå•ä½è¿›è¡Œgroup byã€‚

2ï¸âƒ£ `tb_order_detail`æ˜¯æµæ°´ï¼Œæœ‰å”®ä»·å’Œé”€å”®æ•°é‡çš„æ•°æ®ï¼Œæ˜¯æˆ‘ä»¬è¦è¿›è¡Œè®¡ç®—çš„ä¸»è¦è¡¨æ ¼ã€‚

3ï¸âƒ£ç¬¬ä¸‰å¼ è¡¨`tb_order_overall`ä¸»è¦æ˜¯ç”¨æ¥filteré¢˜ç›®ä¸­çš„å„ç§æ¡ä»¶ï¼Œæ²¡åˆ«çš„ç”¨ã€‚

4ï¸âƒ£ ç»¼ä¸Šï¼Œç­”æ¡ˆçš„éª¨æ¶å¦‚ä¸‹ã€‚é¢˜ç›®å…¶ä»–ä¸€äº›å„ç§conditionæ¯”è¾ƒannoyingï¼Œæ²¡ä»€ä¹ˆåµç”¨ï¼Œå°±çœç•¥å»äº†ã€‚

```sql
select x.product_id, 1- x.in_price * sum(x.cnt) / sum(x.price * x.cnt) as profit_rate
from
(select p.shop_id, p.product_id, p.in_price, detail.price, detail.cnt, t.order_id, t.event_time, t.status 
from
tb_product_info as p
left join
tb_order_detail as detail
on p.product_id = detail.product_id
right join tb_order_overall as t
on detail.order_id = t.order_id
where p.shop_id = 901 and t.event_time >= '2021-10-01' and t.status = 1) as x
group by x.product_id
```

è¿™ä¸ªqueryå°±å¯ä»¥å¾—åˆ°æ¯ä»¶å•†å“çš„æ¯›åˆ©ç‡äº†ã€‚æ¯›åˆ©ç‡æ ¹æ®é¢˜ç›®ç»™å®šçš„æ–¹æ³•è®¡ç®—å³å¯ï¼Œå³

```sql
1- x.in_price * sum(x.cnt) / sum(x.price * x.cnt)
```

å…¶å®å†™åˆ°è¿™é‡Œï¼Œæˆ‘è§‰å¾—å°±å¯ä»¥äº†ï¼Œç›®çš„å°±åŸºæœ¬è¾¾åˆ°äº†ï¼Œå¯ä»¥ä¸å¿…å†å¾€ä¸‹ç»§ç»­æ·±ç©¶ä»¥è¾¾åˆ°æäº¤é€šè¿‡çš„è¦æ±‚ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é“é¢˜æ€è·¯è·Ÿä¸Šé¢æµ™å¤§ä¸åŒé¢˜ç›®æ­£ç¡®ç‡çš„é¢˜ç›®æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚éƒ½æ˜¯æœ‰ä¸ªè¦è¿›è¡Œè®¡ç®—çš„ä¸»è¦çš„æµæ°´è¡¨æ ¼ï¼Œä»¥åŠå…¶ä»–ä¸¤ä¸ªæœ‰æ•°æ®labelçš„è¡¨æ ¼ã€‚æˆ‘ä»¬æŠŠä¸‰ä¸ªè¡¨æ ¼æ ¹æ®æ¯ä¸ªè¡¨æ ¼çš„æ€§è´¨joinåˆ°ä¸€èµ·ï¼Œå¾—åˆ°éœ€è¦çš„å…¨éƒ¨çš„columnï¼Œå†group byå³å¯ã€‚

### è¿›é˜¶æŒ‘æˆ˜ ğŸ‘‘

å¦‚æœè¦æŒ‰é¢˜ç›®è¦æ±‚ï¼Œè¿˜è¦åŠ å…¥ä¸€è¡Œåº—é“ºæ€»ä½“çš„æ¯›åˆ©ç‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å¯¹ä¸Šé¢è¿™ä¸ªderived tableè®¡ç®—ä¸¤æ¬¡ã€‚è¿™æ ·å°±è¦ç”¨åˆ° with statement

```sql
with tb as (...)
select col1, col2... from tb
union all
select col1, col2... from tb
...
```

å¦å¤–ï¼Œæ€»ä½“çš„æ¯›åˆ©ç‡ç­‰äº$1-$æ€»æˆæœ¬/æ€»é”€å”®é¢ï¼Œæ‰€ä»¥è¦è®¡ç®—æ€»ä½“çš„ï¼Œæˆ‘ä»¬è¦æ”¹ä¸€ä¸‹derived tableè¿”å›çš„columnï¼Œå…ˆä¸ç›´æ¥è®¡ç®—æ¯ç§å•†å“çš„æ¯›åˆ©ç‡ï¼Œè€Œæ˜¯å…ˆå¾—åˆ°æ¯ç§å•†å“æ€»æˆæœ¬å’Œæ€»é”€å”®é¢çš„æ•°æ®ï¼š

| product_id | gross cost | gross revenue |
| ---------- | ---------- | ------------- |
| 8001       | ...        | ...           |
| 8003       | ...        | ...           |

ç„¶åæ¯ç§å•†å“çš„æ¯›åˆ©ç‡ç”¨ $1$ å‡å»ä¸¤ä¸ªcolumnç›¸é™¤å³å¯ï¼Œåº—é“ºæ€»ä½“çš„å°±å…ˆæŠŠä¸¤ä¸ªcolumn `sum` èµ·æ¥å†ç”¨$1$å‡å³å¯ï¼Œå³

```sql
1 - sum(gross_cost) / sum(gross_revenue)
```

é‚£ä¹ˆåˆ°è¿™ä¸€æ­¥ï¼Œç­”æ¡ˆå°±æ˜¯

```sql
with y as
(select x.product_id, x.in_price * sum(x.cnt) as gr_cost, sum(x.price * x.cnt) as gr_rev
from
(select p.shop_id, p.product_id, p.in_price, detail.price, detail.cnt, t.order_id, t.event_time, t.status 
from
tb_product_info as p
left join
tb_order_detail as detail
on p.product_id = detail.product_id
right join tb_order_overall as t
on detail.order_id = t.order_id
where p.shop_id = 901 and t.event_time >= '2021-10-01' and t.status = 1) as x
group by x.product_id
)
### end of the y table
select 'åº—é“ºæ±‡æ€»' as product_id, concat(round((1 - sum(y.gr_cost) / sum(y.gr_rev)) * 100, 1), '%') as profit_rate
from y
union all
(select y.product_id, concat(round((1 - y.gr_cost / y.gr_rev) * 100, 1), '%') as profit_rate
from y order by y.product_id)
```

### group by é—®é¢˜è§£å†³ ğŸ’€

å°†ä¸Šé¢çš„ç­”æ¡ˆåœ¨ç½‘ç«™ä¸Šæäº¤ä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯æˆ‘ä»¬selectäº†`x.in_price`è¿™ä¸ªcolumnï¼Œè€Œæˆ‘ä»¬group byçš„æ—¶å€™å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œaggregateã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æä¾›çš„ç­”æ¡ˆä¸­æœ‰`x2`å’Œ`p2`è¿™æ ·çš„è¡¨ã€‚ä¸ºäº†circumventè¿™ä¸ªæŠ¥é”™ï¼Œå°±ä¸å¾—ä¸å†è¿›è¡Œä¸€éjoinå’Œselectï¼Œååˆ†è´¹åŠ²ï¼å¦‚ä¸Šé¢æåˆ°çš„ï¼ŒçœŸæ˜¯æ²¡å¿…è¦è¾ƒè¿™ä¸ªçœŸã€‚å®é™…ä¸­ç”¨

```sql
set global sql_mode=(select replace(@@sql_mode,'ONLY_FULL_GROUP_BY',''));
```

å…³æ‰strict modeå°±è¡Œã€‚


